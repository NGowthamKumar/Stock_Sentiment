name: weekly-train-and-predict

on:
  schedule:
    # Friday 13:30 UTC ≈ 19:00 IST
    - cron: "30 13 * * 5"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: weekly-train-and-predict
  cancel-in-progress: false

jobs:
  train:
    runs-on: ubuntu-latest
    env:
      HF_HOME: ~/.cache/huggingface
      TRANSFORMERS_CACHE: ~/.cache/huggingface

    steps:
      - name: Random jitter (120–300s)
        run: |
          python - << 'PY'
          import random, time
          t = random.randint(120, 300)
          print(f"Sleeping {t}s for polite staggering...")
          time.sleep(t)
          PY

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Cache FinBERT / HF models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-${{ runner.os }}-finbert

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build dataset
        run: python -m src.build_dataset

      - name: Train regression
        run: python -m src.train_regression

      - name: Predict next day
        run: python -m src.predict_next

      - name: Commit models + artifacts
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/*.csv data/history/*.csv data/modeling/*.parquet models/*.pkl || true
          git commit -m "weekly retrain + predictions" || echo "no changes"
          git push || true
